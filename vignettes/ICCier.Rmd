---
title: "ICCier"
author: "Stephen R. Martin"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    readme: true
bibliography: bib.bib
csl: apa.csl
vignette: >
  %\VignetteIndexEntry{ICCier}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=6,fig.height=4,
  message=FALSE,
  error=FALSE,
  warning=FALSE
)
```

# Introduction
`ICCier` is a package for estimating and predicting group-specific or observation-specific intraclass correlation coefficients (ICCs).
In this vignette, we describe the rationale for specific ICCs, and walk the reader through the package with various examples.
First, we provide some background on ICCs and their variety of forms.
In this section, we introduce the reader to the notation used throughout the rest of the vignette.
Second, we describe the rationale for varying ICCs (e.g., group-specific ICCs).
Third, we describe the Bayesian mixed effects location scale model (MELSM) that underlies the estimation of these ICCs.
The MELSM is the "engine" that makes varying ICCs possible, and we encourage all readers to read this section to best understand the model output.
Fourth, we walk through the `ICCier` functions, followed by numerous examples for a variety of scenarios.
Finally, we end with some best practices and tips for using the `ICCier` package.

# Background
## Intraclass Correlation Coefficients
The intraclass correlation coefficient (ICC) represents the proportion of variance that is due to between-group variance.
It can also be thought of as a reliability estimate, or the expected correlation between any two scores within the same group.
There are several ICC variants, and `ICCier` supports many of them.
The ICC(1) represents the proportion of variability in the *observations* due to the grouping factor.
The ICC(2) represents the proportion of variability in the *mean score* estimates that is due to true group mean variability.
The uICC(1) and aICC(1) are conditional ICCs, which are ICCs after controlling for some covariates.
These are all discussed in turn below.

### ICC(1)
The ICC(1) can be expressed as:
$$
\text{ICC(1)} = \frac{\sigma^2_b}{\sigma^2_b + \sigma^2_{\epsilon}},
$$
where $\sigma^2_b$ is the between-group variance, and $\sigma^2_\epsilon$ is the within-group variance.

The ICC(1) is the proportion of total variance in the observations that is due to between-group variance.
The ICC ranges from 0 to 1, with 0 meaning none of the variance is due to between-group variation, and 1 meaning all is due to between-group variation.
The *groups* of data may be many things, such as trials within *persons*, persons within *schools*, regions within *countries*, and so on.
For example, if one has repeated trials within persons, and observes and ICC(1) of .45, then 45\% of the variance in the observations is due to differences between persons.

The ICC(1) can be interpreted as the proportion of total variance that can be attributed to, and explained by, group-level differences and covariates [E.g., See @Raudenbush2002].
Therefore, a low ICC(1) indicates that most explainable variance is due to within-group, and not between-group, variables.
Additionally, the ICC(1) can be interpreted as a reliability measure for individual observations.
If ICC(1) is high, then most variance in scores is due to between-person differences, rather than within-person fluctuations or measurement error.

`ICCier` extends this so that the between-group variance ($\sigma^2_b$) and the within-group variance ($\sigma^2_\epsilon$) can be modeled.
Specifically, `ICCier` defines the ICC(1) more generally as:

$$
\text{ICC(1)}_{ij} = \frac{\hat\sigma^2_{b,i}}{\hat\sigma^2_{b,i} + \hat\sigma^2_{\epsilon,ij}} = \frac{\exp(\boldsymbol{X_i\eta})^2}{\exp(\boldsymbol{X_i\eta})^2 + \exp(\boldsymbol{z_{ij}\gamma_i})^2}
$$
Therefore, an ICC(1) can be predicted for each group (i) and each observation therein (j).
More details about the model implementation are available below ([#model]).

### ICC(2)
The ICC(2) can be expressed as:
$$
\text{ICC(2)} = \frac{\sigma^2_b}{\sigma^2_b + \frac{\sigma^2_\epsilon}{n}},
$$
where $n$ is the number of observations within each group.
The ICC(2) is the same as the ICC(1), except the second variance component is the approximate sampling variance of the mean (i.e., the squared standard error of the mean).
When $n$ varies across groups (i.e., unbalanced groups), it is common to estimate the expected sampling variance by using the average $n_i$ [E.g., See @Raudenbush2002].

The ICC(2) is the proportion of variance in group mean estimates that is due to true between-group variance.
Therefore, the ICC(2) is a reliability measure for group mean estimates.
If ICC(2) is high, then most variance in group mean estimates is due to true group differences, rather than sampling error.

`ICCier` extends this similarly to the ICC(1) above.
$$
\text{ICC(1)}_{ij} = \frac{\hat\sigma^2_{b,i}}{\hat\sigma^2_{b,i} + \hat\sigma^2_{\epsilon,ij}} = \frac{\exp(\boldsymbol{X_i\eta})^2}{\exp(\boldsymbol{X_i\eta})^2 + \frac{\exp(\boldsymbol{z_{ij}\gamma_i})^2}{n_{ij}}}
$$
The $n_{ij}$ can either be the number of observations within the group ($n_{ij} = n_i$), or the number of observations up until the $j$-th observation.
The former provides the predicted ICC(2) at the given covariates assuming the same number of observations are made.
However, the latter allows researchers to examine how mean reliability changes across the number of observations.
For example, the trial number can predict variance components, and also be used as $n_{ij}$.
By doing so, the experimenter can estimate how mean score reliability changes over the course of the experiment.

### uICC(1)

Thus far, we have only described the *unconditional* ICC.
Unconditional ICCs are called "unconditional" because the means are not conditioned on any covariates.
Therefore, the between-group variance is the variance in unconditional means, and the within-group variance is the variance around each group mean.
In contrast, *conditional* ICCs estimate the variance in *conditional* means, and the residual variance is the variance around the *conditional* mean.
That is, conditional ICCs include a model on the expected values of the outcome.
Therefore, $\sigma^2_\epsilon$ is no longer the within-group variance, but the *residual variance* after accounting for the linear predictors.
Moreover, the $\sigma^2_b$ is ill-defined for conditional ICCs, because there is no longer a simple mean estimate for each group.

There are two broad approaches for the $\sigma^2_b$ in conditional ICCs.
One, which we call *unadjusted* (default in `ICCier`) replaces the between-group variance of the means ($\sigma^2_b$) with the between-group variance in the intercept ($\sigma^2_{u_{0i}}$).
The corresponding ICC, labeled uICC(1), can be expressed as:
$$
\text{uICC(1)}_{ij} = \frac{\hat\sigma^2_{u_0,i}}{\hat\sigma^2_{u_0,i} + \hat\sigma^2_{\epsilon,ij}} = \frac{\exp(\boldsymbol{X_i\eta_1})^2}{\exp(\boldsymbol{X_i\eta_1})^2 + \exp(\boldsymbol{z_{ij}\gamma_i})^2}
$$

The uICC(1) represents the proportion of variance (after controlling for the predictors) due to groups, assuming the predictors are all at zero.
If one is interested in the ICC when predictor variables are at zero, then this is the conditional ICC of interest.

### aICC(1)
The second conditional ICC which we call *adjusted* (`adjusted = TRUE`) replaces the between-group variance of the means ($\sigma^2_b$) with the between-group variance of the conditional means ($\sigma^2_{\hat u_{ij}}$).
Whereas the unadjusted ICC only includes the variance between intercepts, the adjusted ICC includes all variance due to between-group differences in the intercepts and slopes.
That is, $\hat u_{ij} = u_{0i} + x_{ij}u_{1i} + \ldots$, and $\sigma^2_b = \text{Var}(\hat u_{ij})$.
The aICC(1) can be expressed as:
$$
\text{aICC(1)}_{ij} = \frac{\hat\sigma^2_{\hat u,ij}}{\hat\sigma^2_{\hat u,ij} + \hat\sigma^2_{\epsilon,ij}} = \frac{\boldsymbol{m_{ij}\Sigma_i^{(L)}m_{ij}'}}{\boldsymbol{m_{ij}\Sigma_i^{(L)}m_{ij}'} + \exp(\boldsymbol{z_{ij}\gamma_i)^2}}
$$
, where $\boldsymbol{m_{ij}}$ is a row of conditional mean predictors for group $i$ on occasion $j$, and $\Sigma_i^{(L)}$ is the group-specific covariance matrix of mean coefficient random effects.
Further details are available in the model description section ([#model]).
When no random slopes are present, adjusted and unadjusted ICCs are equivalent.

The aICC(1) represents the proportion of total residual variance that is due to group-specific variation, as a whole.
Alternatively stated, it represents the proportion of variance that is *predicted* by all random effects.
If one is interested in individual differences (i.e., in intercepts and slopes), then this is the conditional ICC of interest.

## Group and observation-specific ICCs

# The Underlying Model {#model}
This section details the model as implemented in the \texttt{ICCier} package.
Let $y_{ij}$ be the $j$th observation in the $i$th group response vector $\Vector{y}_i$.
Because we are using an unconditional one-way model, the expected response for any $y_{ij}$ is $\mu_i = \beta_0 + u_{0i}$.
The expected residual standard deviation for $y_{ij}$ is log-linearly modeled from a Level 1 design matrix ($\Vector{x_i}$) and coefficient vector ($\Vector{\gamma}_i$).
All Level 1 scale coefficients are modeled using a multivariate linear model from a Level 2 design matrix ($\Vector{X}$), coefficient \emph{matrix} ($\Vector{\Gamma}$), and random effect row vectors ($\Vector{u}^{\sigma\intercal}_{i}$).
Here, $\Vector{X}_i$ is the row vector containing group-level predictors for group $i$.
All random effects ($u_{0i},\Vector{u}^\sigma_i$) are assumed to vary and covary.
The standard deviations of the random effects are similarly modeled using a multivariate linear model from a Level 2 design matrix, and coefficient matrix $\Vector{\eta}$.
Altogether, the model is defined as follows.
\begin{align*}
    \Vector{y}_{i} &\sim \mathcal{N}(\mu_{i}, \Vector{\hat\sigma}_{\epsilon,i}) \\
    \mu_{i} &= \beta_0 + u_{0i} \tag{Location Model} \\
    %\Vector{y}_{i} &= \beta_0 + u_{0i} + \Vector{e}_{i} \tag{Location Model}\\
    \log\Vector{\hat\sigma}_{\epsilon,i} &= \Vector{x}_{i}\Vector{\gamma}_{i} \tag{Level 1 Scale Model}\\
    %\Vector{e}_{i} &\sim \mathcal{N}(0,\Vector{\hat\sigma}_{\epsilon,i}) \\
    %\log\Vector{\hat\sigma}_{\epsilon,i} &= \Vector{x}_{i}\Vector{\gamma}_{i} \tag{Level 1 Scale Model}\\
    \Vector{\gamma}_{i}^\intercal &= \Vector{X}_{i}\Vector{\Gamma} + \Vector{u}^{\sigma\intercal}_i \tag{Level 2 Scale Model}\\
    \begin{bmatrix}
        u_{0i} \\
        \Vector{u}^{\sigma}_i
    \end{bmatrix} &\sim \mathcal{N}(\Vector{0},\Vector{\Sigma}_i = \Vector{\sigma}_i\Vector{\Omega}\Vector{\sigma}_i) \\
    \diag(\log\Vector{\sigma}_i)^\intercal &= \Vector{X}_i\Vector{\eta} \tag{Between-group Scale Model} 
%    \text{ICC(1)}_{ij} &= \frac{\exp(\Vector{X}_i\Vector{\eta}_{\bullet 1})^2}{\exp(\Vector{X}_i\Vector{\eta}_{\bullet 1})^2 + \exp(\Vector{x}_{ij}\Vector{\gamma}_i)^2}
\end{align*}
The expected unconditional ICC(1)$_{ij}$ is therefore
\begin{align*}
    \text{ICC(1)}_{ij} &= \frac{\sigma_{b,i}^2}{\sigma_{b,i}^2 + \hat\sigma^2_{\epsilon,ij}} \\
    &= \frac{\exp(\Vector{X}_i\Vector{\eta}_{\bullet 1})^2}{\exp(\Vector{X}_i\Vector{\eta}_{\bullet 1})^2 + \exp(\Vector{x}_{ij}\Vector{\gamma}_i)^2},
\end{align*}
where $\Vector{\eta}_{\bullet 1}$ refers to the first column of $\Vector{\eta}$, which specifically contains the predictive coefficients for the group mean standard deviation (i.e., for $\sigma_{b,i}$).

The model implemented by \texttt{ICCier} employs a maximal structure, such that every level 2 variable predicts each level 1 coefficient.
This allows researchers to explore the impact of level 2 variables on the level 1 scale model.
In practice, this does not affect the estimated ICCs.
The ICC calculation only requires the predicted between-group and within-group variance.
If one only had a level 1 scale model, with no level 2 predictors, then the random effect variances would be larger than with level 2 covariates.
Consequently, the random effects would change, but the predicted within-person variance would be the same.
Therefore, although the model is maximal, the dense $\Vector{\Gamma}$ matrix provides additional insight into varying ICCs without affecting the estimated ICCs themselves.
\subsubsection{Priors}
Broadly, there are four sets of parameters for which priors must be defined: Fixed location intercept ($\beta_0$), fixed scale coefficients ($\Vector{\Gamma}$), between-person scale coefficients ($\Vector{\eta}$), and the random effect correlations ($\Vector{\Omega}$).
In practice, one should choose priors based on the a-priori known characteristics of the data, such that the priors imply reasonable expected values and variances for the given scenario \citep{Gelman2017_prior_likelihood}.
Nevertheless, the following priors were specified to accommodate a wide range of possible data.
\begin{align*}
    \beta_0 &\sim \mathcal{N}(0,10) \\
    \Gamma_{pq} &\sim \mathcal{ST}(\nu = 3, \mu = 0, \sigma = 5), \forall p,q \\
    \eta_{pq} &\sim \mathcal{ST}(\nu = 3, \mu = 0, \sigma = 5), \forall p,q \\
    \Vector{\Omega} &\sim LKJ(1)
\end{align*}
Note that $\Gamma_{pq}$ and $\eta_{pq}$ represent elements in the respective $\Vector{\Gamma}$ and $\Vector{\eta}$ coefficient matrices.
Each element in these coefficient matrices is given a heavy-tailed Student T prior.
%We recommend using a heavy-tailed prior for scale model parameters.
The heavy-tailed prior accommodates variances approaching zero better than a normal distribution permits.
In our testing of this model, between-group variances in particular may be small or effectively zero, and the wide-tailed priors effectively attenuated any sampling problems.
The LKJ prior is a spherical prior over correlation matrices that takes a single parameter.
We set the parameter to one, implying a uniform prior over correlation matrices [@lewandowski2009b].

# Function Overview

## `ICCier`
## `summary`
## `predict` and `fitted`
## `ranef` and `coef`
## `loo`

# Examples

## Unconditional, Intercept-only

## Unconditional, Scale Model

## Conditional, Intercept-only

## Conditional, Scale Model

## Level 2 Variables

# Model Comparison

# Best Practices

## Diagnostic Failures and You

## Scaling and Centering

## Pre-Filtering (Self: as in, using complete cases only, so fitted can be combined easily)

# References
